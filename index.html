<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ev B√ºt√ße Ultra</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2e86de;
            --secondary: #27ae60;
            --danger: #e74c3c;
            --bg: #f4f6f9;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); padding: 15px; color: #333; }
        h2 { text-align: center; color: #2c3e50; }
        .card { background: #fff; padding: 20px; margin-top: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,.08); }
        input, select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 14px; }
        button { background: var(--primary); color: #fff; border: none; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: .9; }
        .btn-secondary { background: #7f8c8d; margin-top: 5px; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .delete { color: var(--danger); cursor: pointer; font-weight: bold; padding: 5px; }
        .delete:hover { background: #fee; border-radius: 4px; }
        
        .progress { background: #eee; border-radius: 20px; height: 18px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.5s ease-in-out; }
        
        .stat-grid { display: grid; grid-template-cols: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 13px; }
        .balance-box { text-align: center; font-size: 18px; margin: 15px 0; border-top: 1px solid #eee; pt: 10px; }
        
        canvas { max-height: 300px; margin-top: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h2>üè† Ev B√ºt√ße Ultra</h2>

    <div class="card">
        <input id="amountInput" type="number" placeholder="Tutar (‚Ç∫)">
        <select id="typeInput">
            <option value="income">Gelir (+)</option>
            <option value="expense">Gider (-)</option>
        </select>
        <input id="categoryInput" placeholder="Kategori (√ñrn: Market, Maa≈ü)">
        <input id="dateInput" type="date">
        <button onclick="addTransaction()">ƒ∞≈ülemi Ekle</button>
    </div>

    <div class="card">
        <input id="searchInput" placeholder="Kategoriye g√∂re ara..." oninput="updateUI()">
    </div>

    <div class="card">
        <div class="stat-grid">
            <div class="stat-box">Gelir: <br><b id="incomeSpan" style="color:var(--secondary)">0</b> ‚Ç∫</div>
            <div class="stat-box">Gider: <br><b id="expenseSpan" style="color:var(--danger)">0</b> ‚Ç∫</div>
        </div>
        <div class="balance-box">
            <b>Net Kalan: <span id="balanceSpan">0</span> ‚Ç∫</b>
        </div>
        <p class="stat-box">üî• En √áok Harcanan: <span id="topCategory">-</span></p>
        <p class="stat-box">üìÖ Son 7 G√ºn Gider: <span id="last7">0</span> ‚Ç∫</p>
    </div>

    <div class="card">
        <input id="goalInput" type="number" placeholder="Birikim Hedefinizi Girin">
        <button onclick="setGoal()">Hedef Belirle</button>
        <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
        <p style="text-align:center; font-size:14px; margin-top:5px;">Hedef ƒ∞lerlemesi: %<span id="goalPercent">0</span></p>
    </div>

    <div class="card">
        <canvas id="pieChart"></canvas>
        <canvas id="lineChart"></canvas>
    </div>

    <div class="card">
        <h3>ƒ∞≈ülem Ge√ßmi≈üi</h3>
        <div id="listContainer"></div>
    </div>

    <div class="card" style="display: flex; gap: 5px; flex-wrap: wrap;">
        <button onclick="exportCSV()" style="flex:1">CSV ƒ∞ndir</button>
        <button onclick="backupJSON()" style="flex:1" class="btn-secondary">Yedek Al</button>
        <input type="file" id="fileInput" onchange="restoreJSON(event)" style="display:none">
        <button onclick="document.getElementById('fileInput').click()" style="flex:1" class="btn-secondary">Yedeƒüi Y√ºkle</button>
    </div>

<script>
    // Elementleri Se√ßelim
    const amountInput = document.getElementById("amountInput");
    const typeInput = document.getElementById("typeInput");
    const categoryInput = document.getElementById("categoryInput");
    const dateInput = document.getElementById("dateInput");
    const searchInput = document.getElementById("searchInput");
    const incomeSpan = document.getElementById("incomeSpan");
    const expenseSpan = document.getElementById("expenseSpan");
    const balanceSpan = document.getElementById("balanceSpan");
    const topCategory = document.getElementById("topCategory");
    const last7Span = document.getElementById("last7");
    const goalInput = document.getElementById("goalInput");
    const progressBar = document.getElementById("progressBar");
    const goalPercent = document.getElementById("goalPercent");
    const listContainer = document.getElementById("listContainer");
    const pieChartCtx = document.getElementById("pieChart");
    const lineChartCtx = document.getElementById("lineChart");

    let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
    let goal = Number(localStorage.getItem("goal")) || 0;
    let pie, line;

    // Veriyi Kaydet
    function save() {
        localStorage.setItem("transactions", JSON.stringify(transactions));
        localStorage.setItem("goal", goal);
    }

    // Yeni ƒ∞≈ülem Ekle
    function addTransaction() {
        const val = Number(amountInput.value);
        if (!val || !categoryInput.value || !dateInput.value) {
            alert("L√ºtfen t√ºm alanlarƒ± doldurun!");
            return;
        }

        transactions.push({
            amount: val,
            type: typeInput.value,
            category: categoryInput.value,
            date: dateInput.value
        });

        // Tarihe g√∂re sƒ±rala (Yeni en √ºstte)
        transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

        save();
        updateUI();
        
        amountInput.value = ""; 
        categoryInput.value = "";
    }

    function deleteTransaction(i) {
        if(confirm("Bu i≈ülemi silmek istediƒüinize emin misiniz?")) {
            transactions.splice(i, 1);
            save();
            updateUI();
        }
    }

    function setGoal() {
        goal = Number(goalInput.value);
        save();
        updateUI();
    }

    // Aray√ºz√º G√ºncelle
    function updateUI() {
        let income = 0, expense = 0, last7 = 0;
        let expenseCategories = {};
        const searchTerm = searchInput.value.toLowerCase();
        
        listContainer.innerHTML = "";

        transactions.forEach((t, i) => {
            if (searchTerm && !t.category.toLowerCase().includes(searchTerm)) return;

            if (t.type === "income") {
                income += t.amount;
            } else {
                expense += t.amount;
                // Son 7 g√ºn gideri
                let diff = (new Date() - new Date(t.date)) / (1000 * 60 * 60 * 24);
                if (diff <= 7 && diff >= 0) last7 += t.amount;
                // Kategori bazlƒ± gider (Pasta grafiƒüi i√ßin)
                expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
            }

            listContainer.innerHTML += `
                <div class="list-item">
                    <span><strong>${t.date}</strong> | ${t.category}</span>
                    <span style="color: ${t.type === 'income' ? '#27ae60' : '#e74c3c'}">
                        ${t.type === 'income' ? '+' : '-'}${t.amount.toLocaleString()} ‚Ç∫
                        <span class="delete" onclick="deleteTransaction(${i})"> ‚úï</span>
                    </span>
                </div>`;
        });

        // ƒ∞statistikleri Yazdƒ±r
        const balance = income - expense;
        incomeSpan.textContent = income.toLocaleString();
        expenseSpan.textContent = expense.toLocaleString();
        balanceSpan.textContent = balance.toLocaleString();
        balanceSpan.style.color = balance < 0 ? "#e74c3c" : "#2d3436";
        last7Span.textContent = last7.toLocaleString();

        // En √ßok harcanan kategori bulma
        let top = Object.keys(expenseCategories).reduce((a, b) => expenseCategories[a] > expenseCategories[b] ? a : b, "-");
        topCategory.textContent = top;

        // Hedef Barƒ±
        let percent = goal > 0 ? (balance / goal) * 100 : 0;
        percent = Math.max(0, Math.min(100, percent));
        progressBar.style.width = percent + "%";
        goalPercent.textContent = Math.round(percent);

        drawCharts(income, expense, expenseCategories);
    }

    // Grafik √áizimi
    function drawCharts(income, expense, expenseCategories) {
        if (pie) pie.destroy();
        if (line) line.destroy();

        // Pasta Grafiƒüi: Gider Daƒüƒ±lƒ±mƒ±
        pie = new Chart(pieChartCtx, {
            type: "doughnut",
            data: {
                labels: Object.keys(expenseCategories).length ? Object.keys(expenseCategories) : ["Veri Yok"],
                datasets: [{
                    data: Object.keys(expenseCategories).length ? Object.values(expenseCategories) : [1],
                    backgroundColor: ["#3498db", "#9b59b6", "#f1c40f", "#e67e22", "#1abc9c", "#e74c3c"]
                }]
            },
            options: { 
                responsive: true,
                plugins: { title: { display: true, text: 'Giderler (Kategori Bazlƒ±)' } } 
            }
        });

        // √áizgi Grafiƒüi: G√ºnl√ºk Gidi≈üat
        let daily = {};
        [...transactions].reverse().forEach(t => {
            daily[t.date] = (daily[t.date] || 0) + (t.type === "income" ? t.amount : -t.amount);
        });

        line = new Chart(lineChartCtx, {
            type: "line",
            data: {
                labels: Object.keys(daily),
                datasets: [{
                    label: "G√ºnl√ºk Durum (‚Ç∫)",
                    data: Object.values(daily),
                    borderColor: "#2e86de",
                    backgroundColor: "rgba(46, 134, 222, 0.1)",
                    fill: true,
                    tension: 0.3
                }]
            }
        });
    }

    // Dƒ±≈üa Aktarma Fonksiyonlarƒ±
    function exportCSV() {
        let csv = "\uFEFFTarih,Kategori,Tip,Tutar\n"; // T√ºrk√ße karakter desteƒüi i√ßin BOM eklendi
        transactions.forEach(t => csv += `${t.date},${t.category},${t.type},${t.amount}\n`);
        let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "butce_ozeti.csv";
        a.click();
    }

    function backupJSON() {
        let data = JSON.stringify({ transactions, goal });
        let blob = new Blob([data], { type: "application/json" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "butce_yedek.json";
        a.click();
    }

    function restoreJSON(e) {
        let reader = new FileReader();
        reader.onload = function() {
            let data = JSON.parse(reader.result);
            transactions = data.transactions || [];
            goal = data.goal || 0;
            save();
            updateUI();
            alert("Yedek ba≈üarƒ±yla y√ºklendi!");
        };
        reader.readAsText(e.target.files[0]);
    }

    // Sayfa A√ßƒ±lƒ±≈üƒ±nda Ba≈ülat
    updateUI();
</script>

</body>
</html>
