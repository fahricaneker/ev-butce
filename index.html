<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiÅŸisel CFO: AkÄ±llÄ± Analiz</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee; --success: #10b981; --danger: #ef4444; 
            --warning: #f59e0b; --info: #3b82f6; --bg: #0f172a; 
            --card: #1e293b; --border: #334155; --text: #f8fafc; --text-dim: #94a3b8;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: 13px; }
        .container { max-width: 1450px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; }
        .card { background: var(--card); border-radius: 16px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; }
        .card h3 { margin: 0 0 15px 0; font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--info); letter-spacing: 1px; }
        .net-worth { font-size: 32px; font-weight: 800; color: #fff; margin-bottom: 10px; }
        
        /* AI Analiz Kutusu Stili */
        .ai-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--info); border-radius: 12px; padding: 15px; }
        .ai-status { display: flex; align-items: center; gap: 8px; font-weight: 700; margin-bottom: 8px; font-size: 12px; }
        .ai-msg { line-height: 1.6; color: #e2e8f0; font-size: 12.5px; }
        .ai-alert { color: var(--danger); font-weight: 600; }

        input, select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); border-radius: 8px; color: #fff; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; background: var(--primary); color: white; transition: 0.2s; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border); }
        .val-inc { color: var(--success); } .val-exp { color: var(--danger); }
        
        @media (max-width: 1000px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h1 style="margin:0; font-size: 22px;">KÄ°ÅÄ°SEL <span style="color:var(--primary)">CFO PRO</span></h1>
        <button onclick="clearAll()" style="width:auto; background:none; color:var(--text-dim); border:1px solid var(--border); padding: 5px 15px;">SÄ±fÄ±rla</button>
    </header>

    <div class="grid">
        <div class="col">
            <div class="card">
                <h3>ğŸ’° NET VARLIK</h3>
                <div class="net-worth" id="netWorthDisplay">0 â‚º</div>
                <div id="assetLiabInfo" style="font-size: 11px; color: var(--text-dim);"></div>
            </div>

            <div class="card">
                <h3>ğŸ¤– CFO ANALÄ°Z RAPORU</h3>
                <div class="ai-box">
                    <div id="aiStatus" class="ai-status">
                        <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                        SÄ°STEM AKTÄ°F
                    </div>
                    <div id="aiReport" class="ai-msg">Veri giriÅŸi yapÄ±ldÄ±ÄŸÄ±nda gerÃ§ek zamanlÄ± analiz burada gÃ¶rÃ¼necek.</div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ HARCAMA DAÄILIMI</h3>
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="col">
            <div class="card">
                <h3>ğŸ’³ YENÄ° Ä°ÅLEM</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="number" id="amount" placeholder="Tutar (â‚º)">
                    <select id="type">
                        <option value="expense">Gider / BorÃ§ Ã–deme (-)</option>
                        <option value="income">Gelir (+)</option>
                    </select>
                </div>
                <select id="categorySelect"></select>
                <input type="text" id="note" placeholder="Not (Opsiyonel)">
                <input type="date" id="date">
                <button onclick="addTransaction()">KAYDET</button>
            </div>

            <div class="card">
                <h3>ğŸ“œ SON Ä°ÅLEMLER</h3>
                <div id="historyList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="col">
            <div class="card" style="border-top: 3px solid var(--danger);">
                <h3>ğŸ“‰ AKTÄ°F BORÃ‡LAR</h3>
                <div style="display: flex; gap: 5px; margin-bottom:10px;">
                    <input type="text" id="debtName" placeholder="BorÃ§ AdÄ±" style="margin:0">
                    <input type="number" id="debtAmt" placeholder="â‚º" style="margin:0; width: 80px;">
                    <button onclick="addDebt()" style="width: 45px; background:var(--danger)">+</button>
                </div>
                <div id="debtList"></div>
            </div>

            <div class="card" style="border-top: 3px solid var(--success);">
                <h3>ğŸ’ VARLIKLAR</h3>
                <div style="display: flex; gap: 5px; margin-bottom:10px;">
                    <input type="text" id="invName" placeholder="VarlÄ±k" style="margin:0">
                    <input type="number" id="invVal" placeholder="â‚º" style="margin:0; width: 80px;">
                    <button onclick="addInvestment()" style="width: 45px; background:var(--success)">+</button>
                </div>
                <div id="investmentList"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem("cfo_v3_logic")) || {
        transactions: [],
        categories: ["MaaÅŸ", "Market", "Kira", "Fatura", "EÄŸlence"],
        investments: [],
        debts: []
    };

    let chart;
    function save() { localStorage.setItem("cfo_v3_logic", JSON.stringify(db)); }

    function addDebt() {
        const name = document.getElementById('debtName').value.trim();
        const amt = Number(document.getElementById('debtAmt').value);
        if(name && amt) {
            db.debts.push({ id: Date.now(), name, total: amt, remaining: amt });
            render(); save();
            document.getElementById('debtName').value = ""; document.getElementById('debtAmt').value = "";
        }
    }

    function addInvestment() {
        const name = document.getElementById('invName').value.trim();
        const val = Number(document.getElementById('invVal').value);
        if(name && val) { db.investments.push({ id: Date.now(), name, val }); render(); save(); }
    }

    function addTransaction() {
        const amt = Number(document.getElementById('amount').value);
        const cat = document.getElementById('categorySelect').value;
        const type = document.getElementById('type').value;
        const date = document.getElementById('date').value;
        const note = document.getElementById('note').value;

        if(!amt || !date) return alert("Hata: Tutar ve tarih gerekli.");

        // BorÃ§tan DÃ¼ÅŸme MantÄ±ÄŸÄ±
        if(type === 'expense' && cat.startsWith("BORÃ‡: ")) {
            const dName = cat.replace("BORÃ‡: ", "");
            const idx = db.debts.findIndex(d => d.name === dName);
            if(idx !== -1) db.debts[idx].remaining -= amt;
        }

        db.transactions.unshift({ id: Date.now(), amt, cat, type, date, note });
        render(); save();
        document.getElementById('amount').value = "";
    }

    function render() {
        // Kategorileri gÃ¼ncelle (BorÃ§larÄ± iÃ§ine dahil et)
        const catSelect = document.getElementById('categorySelect');
        let catHTML = db.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        let debtCats = db.debts.map(d => `<option value="BORÃ‡: ${d.name}">BorÃ§ Ã–deme: ${d.name}</option>`).join('');
        catSelect.innerHTML = catHTML + `<optgroup label="BorÃ§lar">` + debtCats + `</optgroup>`;

        let income = 0, expense = 0, debtRem = 0, invTotal = 0, debtPaymentTotal = 0;
        let catData = {};

        // BorÃ§ Render
        const dList = document.getElementById('debtList'); dList.innerHTML = "";
        db.debts.forEach(d => {
            debtRem += d.remaining;
            dList.innerHTML += `<div class="list-item"><span>${d.name}</span><span class="${d.remaining <= 0 ? 'val-inc' : 'val-exp'}">${d.remaining.toLocaleString()} â‚º</span></div>`;
        });

        // Ä°ÅŸlemler ve Kategori GrafiÄŸi HazÄ±rlÄ±ÄŸÄ±
        const hList = document.getElementById('historyList'); hList.innerHTML = "";
        db.transactions.forEach(t => {
            if(t.type === 'income') income += t.amt;
            else {
                expense += t.amt;
                catData[t.cat] = (catData[t.cat] || 0) + t.amt;
                if(t.cat.startsWith("BORÃ‡: ")) debtPaymentTotal += t.amt;
            }
            hList.innerHTML += `<div class="list-item"><div><b>${t.cat}</b><br><small>${t.date}</small></div><span class="val-${t.type==='income'?'inc':'exp'}">${t.amt.toLocaleString()} â‚º</span></div>`;
        });

        // VarlÄ±klar
        const iList = document.getElementById('investmentList'); iList.innerHTML = "";
        db.investments.forEach(i => {
            invTotal += i.val;
            iList.innerHTML += `<div class="list-item"><span>${i.name}</span><span class="val-inc">${i.val.toLocaleString()} â‚º</span></div>`;
        });

        const netWorth = (income + invTotal) - (expense + debtRem);
        document.getElementById('netWorthDisplay').textContent = netWorth.toLocaleString() + " â‚º";
        document.getElementById('assetLiabInfo').innerHTML = `VarlÄ±klar: ${ (income + invTotal).toLocaleString() } â‚º | BorÃ§lar: ${debtRem.toLocaleString()} â‚º`;

        updateChart(catData);
        runDeepAI(income, expense, debtRem, debtPaymentTotal, invTotal);
    }

    // --- GERÃ‡EKÃ‡Ä° ANALÄ°Z MOTORU ---
    function runDeepAI(inc, exp, dRem, dPay, inv) {
        const report = document.getElementById('aiReport');
        let analysis = "";

        if(inc === 0 && exp === 0) return;

        // 1. Nakit AkÄ±ÅŸÄ± Analizi
        let flow = inc - exp;
        if(flow < 0) analysis += `âš ï¸ <b>Ciddi Nakit AÃ§Ä±ÄŸÄ±:</b> Bu ay gelirinizden ${Math.abs(flow).toLocaleString()} â‚º daha fazla harcadÄ±nÄ±z. Acilen "Ä°stek" harcamalarÄ±nÄ± kÄ±sÄ±p bÃ¼tÃ§eyi dengelemelisiniz. <br><br>`;
        else analysis += `âœ… <b>Pozitif AkÄ±ÅŸ:</b> Harcamalardan sonra elinizde ${flow.toLocaleString()} â‚º kalÄ±yor. <br><br>`;

        // 2. BorÃ§ Analizi
        if(dRem > 0) {
            let debtRatio = (dPay / inc) * 100;
            if(inc > 0) {
                analysis += `ğŸ” <b>BorÃ§ Durumu:</b> Gelirinizin %${debtRatio.toFixed(1)}'ini borÃ§ Ã¶demeye ayÄ±rÄ±yorsunuz. `;
                if(debtRatio > 40) analysis += `<span class="ai-alert">Bu oran Ã§ok yÃ¼ksek! Finansal Ã¶zgÃ¼rlÃ¼ÄŸÃ¼nÃ¼z risk altÄ±nda.</span> `;
            }
            
            if(dPay > 0) {
                let monthsLeft = Math.ceil(dRem / dPay);
                analysis += `Mevcut Ã¶deme hÄ±zÄ±yla borÃ§larÄ±nÄ±z <b>${monthsLeft} ay</b> iÃ§inde tamamen bitecek. `;
            }
            analysis += "<br><br>";
        }

        // 3. YatÄ±rÄ±m ve GÃ¼venlik MarjÄ±
        let emergencyFund = inv / (exp || 1);
        if(inv > 0) {
            analysis += `ğŸ’ <b>VarlÄ±k Analizi:</b> Mevcut yatÄ±rÄ±mlarÄ±nÄ±z, hiÃ§ geliriniz olmasa bile sizi <b>${emergencyFund.toFixed(1)} ay</b> boyunca aynÄ± standartta yaÅŸatabilir. `;
            if(emergencyFund < 3) analysis += "Acil durum fonunuzu 6 aya tamamlamaya Ã§alÄ±ÅŸÄ±n.";
        }

        report.innerHTML = analysis || "Verileriniz analiz ediliyor, harcama yaptÄ±kÃ§a rapor detaylanacak.";
    }

    function updateChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    data: Object.values(data),
                    backgroundColor: ['#4361ee', '#10b981', '#ef4444', '#f59e0b', '#3b82f6'],
                    borderWidth: 0
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });
    }

    function clearAll() { if(confirm("TÃ¼m kayÄ±tlar silinecek. Emin misiniz?")) { localStorage.clear(); location.reload(); } }
    document.getElementById('date').valueAsDate = new Date();
    render();
</script>
</body>
</html>
